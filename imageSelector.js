class ImageSelector{constructor(inputId){this.input=document.getElementById(inputId);if(!this.input){console.error(`No input element found with id: ${inputId}`);return}this.allowedExtensions=["jpg","jpeg","png","gif"];this.lastUploadedImage="";this.init()}init(){const btn2=document.createElement("button");btn2.type="button";btn2.textContent="";btn2.className="btn btn-secondary ms-2 fa fa-eye btnpic";btn2.addEventListener("click",()=>this.updateImagePreview());this.input.insertAdjacentElement("afterend",btn2);const btn=document.createElement("button");btn.type="button";btn.textContent="";btn.className="btn btn-primary ms-2 fa fa-picture-o btnpic";btn.addEventListener("click",()=>this.openPopup());this.input.insertAdjacentElement("afterend",btn);this.imagePreview=document.createElement("div");this.imagePreview.id=`${this.input.id}-imagePreview`;this.input.insertAdjacentElement("afterend",this.imagePreview);this.createModal();this.applyStyles();this.input.addEventListener("input",()=>this.updateImagePreview());window.addEventListener("load",()=>this.updateImagePreview())}createModal(){const modalId=`imageModal-${this.input.id}`;this.modal=document.createElement("div");this.modal.id=modalId;this.modal.className="modal fade";this.modal.setAttribute("tabindex","-1");this.modal.setAttribute("aria-hidden","true");this.modal.innerHTML=`\n            <div class="modal-dialog">\n                <div class="modal-content">\n                    <div class="modal-header">\n                        <h5 class="modal-title">اختر صورة</h5>\n                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                    </div>\n                    <div class="modal-body">\n                        <div id="uploadSection">\n                            <input type="file" id="uploadInput" class="form-control mb-3">\n                            <button class="btn btn-success" id="uploadButton">رفع الصورة</button>\n                            <div class="progress mt-2" style="display: none;" id="progressContainer">\n                                <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar"></div>\n                            </div>\n                            <small class="text-muted d-block mt-2" id="uploadMessage"></small>\n                        </div>\n                        <hr>\n                        <input type="text" id="searchInput" class="form-control mb-3" placeholder="بحث باسم الصورة">\n                        <div class="image-container" id="imageContainer"></div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>\n                        <button class="btn btn-primary" id="confirmSelection">موافق</button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.appendChild(this.modal);this.imageContainer=this.modal.querySelector("#imageContainer");this.confirmBtn=this.modal.querySelector("#confirmSelection");this.uploadInput=this.modal.querySelector("#uploadInput");this.uploadBtn=this.modal.querySelector("#uploadButton");this.progressBar=this.modal.querySelector("#progressBar");this.progressContainer=this.modal.querySelector("#progressContainer");this.uploadMessage=this.modal.querySelector("#uploadMessage");this.searchInput=this.modal.querySelector("#searchInput");this.bootstrapModal=new bootstrap.Modal(this.modal);this.selectedImage="";this.confirmBtn.addEventListener("click",()=>this.confirmSelection());this.uploadBtn.addEventListener("click",()=>this.uploadImage());this.searchInput.addEventListener("input",()=>this.filterImages())}applyStyles(){const style=document.createElement("style");style.textContent=`\n            .modal-dialog {\n                max-width: 80%; /* عرض أكبر للنافذة */\n            }\n            .image-preview {\n                width: 150px;\n                margin-top: 5px;\n                margin-bottom: 5px;\n            }\n            .image-container {\n                max-height: 400px;\n                overflow-y: auto;\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n            }\n            .image-item {\n                flex: 0 0 calc(12.5% - 10px);\n                text-align: center;\n                cursor: pointer;\n                border: 1px solid #ccc;\n                border-radius: 5px;\n                padding: 5px;\n                transition: transform 0.3s ease, border-color 0.3s ease;\n            }\n            .image-item img {\n                max-width: 100%;\n                height: auto;\n                border-radius: 3px;\n            }\n            .image-item.selected {\n                border-color: #007bff;\n                transform: scale(1.05);\n            }\n            /* تقليص حجم الصورة المعروضة */\n            .image-preview img {\n                max-width: 150px; /* يمكنك تغيير هذا الرقم حسب الحجم المطلوب */\n                height: auto;\n            }\n        `;document.head.appendChild(style)}openPopup(){this.fetchImages();this.bootstrapModal.show();this.uploadInput.value="";this.uploadMessage.textContent="";this.searchInput.value=""}fetchImages(){fetch("get_images.php").then(response=>response.json()).then(images=>{this.imageContainer.innerHTML="";images.forEach(image=>{const div=document.createElement("div");div.className="image-item";div.innerHTML=`\n                        <img src="files/${image}" alt="${image}">\n                        <p>${image}</p>\n                    `;div.addEventListener("click",()=>{document.querySelectorAll(".image-item").forEach(item=>item.classList.remove("selected"));div.classList.add("selected");this.selectedImage=image});this.imageContainer.appendChild(div);if(image===this.lastUploadedImage){div.click()}})}).catch(err=>console.error("Error fetching images:",err))}confirmSelection(){if(this.selectedImage){this.input.value=this.selectedImage;this.bootstrapModal.hide();this.updateImagePreview()}}uploadImage(){const file=this.uploadInput.files[0];if(!file){this.displayMessage("يرجى اختيار ملف قبل رفعه.","text-danger");return}const extension=file.name.split(".").pop().toLowerCase();if(!this.allowedExtensions.includes(extension)){this.displayMessage("نوع الملف غير مسموح. يرجى اختيار صورة.","text-danger");return}const formData=new FormData;formData.append("file",file);this.progressContainer.style.display="block";this.progressBar.style.width="0%";fetch("upload_image.php",{method:"POST",body:formData}).then(response=>response.json()).then(result=>{if(result.success){this.displayMessage("تم رفع الصورة بنجاح.","text-success");this.lastUploadedImage=result.fileName;this.fetchImages()}else if(result.error==="duplicate"){this.displayMessage("اسم الصورة موجود بالفعل.","text-danger")}else{this.displayMessage("حدث خطأ أثناء رفع الصورة.","text-danger")}}).catch(err=>{this.displayMessage("فشل الاتصال بالخادم.","text-danger");console.error("Error uploading image:",err)}).finally(()=>{this.progressContainer.style.display="none"})}filterImages(){const query=this.searchInput.value.toLowerCase();document.querySelectorAll(".image-item").forEach(item=>{const name=item.querySelector("p").textContent.toLowerCase();item.style.display=name.includes(query)?"block":"none"})}updateImagePreview(){const imageName=this.input.value.trim();if(imageName){this.imagePreview.innerHTML=`<img src="files/${imageName}" alt="${imageName}" class="image-preview">`}else{this.imagePreview.innerHTML=""}}displayMessage(message,className){this.uploadMessage.textContent=message;this.uploadMessage.className=className}}
